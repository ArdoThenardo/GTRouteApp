@page "/devmode/layouts"
@using GTRouteApp.Data
@inject DevModeService DevModeService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<PageTitle>Dev Mode - Manage Track Layouts</PageTitle>

<div class="manage-layouts-container">
    <div class="layouts-form-nav">
        <button type="button" class="btn btn-primary" @onclick="BackToList">
            <span class="bi bi-arrow-left-square-fill"></span> Back
        </button>
    </div>

    <div class="layouts-form-content">
        <div class="form-title">
            <h5>Manage Layouts for @TrackName</h5>
        </div>

        <EditForm Model="@editModel" OnValidSubmit="SubmitLayout">
            <div class="layouts-form-group">
                <div class="form-group-1">
                    <div class="form-img">
                        <img src="@previewMapUrl" alt="Preview layout map" />
                    </div>
                </div>

                <div class="form-group-2">
                    <div class="form-block-row">
                        <form class="form-floating">
                            <InputText @bind-Value="editModel.Name" class="form-control" placeholder="Insert track layout name" />
                            <label>Layout Name</label>
                        </form>
                        <ValidationMessage For="@(() => editModel.Name)" />
                    </div>

                    <div class="form-block-row" style="margin-bottom: 2px;">
                        <form class="form-floating">
                            <InputText @bind-Value="editModel.MapUrl" 
                                @onfocusout="SetPreviewMap" 
                                class="form-control" 
                                placeholder="Insert the url to image track layout map" />
                            <label>Map Url</label>
                        </form>
                        <ValidationMessage For="@(() => editModel.MapUrl)" />
                    </div>

                    <p style="font-size: 12px; margin-bottom: 8px;">
                        *Instruction for Map Url: Insert a url image and then check if a url is 
                        valid and able to show image inside box on the left
                    </p>

                    <div class="form-row">
                        <div class="form-w50">
                            <form class="form-floating">
                                <InputNumber @bind-Value="editModel.Length" min="0" class="form-control" placeholder="Insert track layout length (m)" />
                                <label>Length &#40;m&#41;</label>
                            </form>
                            <ValidationMessage For="@(() => editModel.Length)" />
                        </div>

                        <div class="form-w50">
                            <form class="form-floating">
                                <InputNumber @bind-Value="editModel.Corners" min="0" class="form-control" placeholder="Insert number of turns" />
                                <label>Corners</label>
                            </form>
                            <ValidationMessage For="@(() => editModel.Corners)" />
                        </div>
                    </div>

                    <div class="form-block-row">
                        <button type="submit" class="btn btn-success">
                            <span class="bi bi-plus-lg"></span> Add
                        </button>
                    </div>
                </div>
            </div>

            <DataAnnotationsValidator />
        </EditForm>

        <div class="layouts-list">
            @foreach (var layoutItem in layouts)
            {
                <div class="layout-list-item">
                    <div class="item-group-1">
                        <div class="item-img">
                            <img src="@layoutItem.MapUrl" alt="@layoutItem.Name" />
                        </div>
                    </div>

                    <div class="item-group-2">
                        <div class="item-info-row">
                            <p>@layoutItem.Name</p>
                        </div>

                        <div class="item-info-row-multi">
                            <div class="form-w50">
                                <p class="detail-label">Length</p>
                                <p class="detail-value">@layoutItem.Length m</p>
                            </div>
                            <div class="form-w50">
                                <p class="detail-label">Corners</p>
                                <p class="detail-value">@layoutItem.Corners</p>
                            </div>
                        </div>

                        <div class="item-action-row">
                            <button type="button" class="btn btn-danger" @onclick="() => DeleteLayout(layoutItem.Name)">
                                <span class="bi bi-trash-fill"></span>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "slug")] 
    public string Slug { get; set; } = "";

    [Parameter]
    [SupplyParameterFromQuery(Name = "name")]
    public string TrackName { get; set; } = "";

    private List<TrackLayout> layouts = new();
    private LayoutEditModel editModel = new();
    private string previewMapUrl = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadLayouts(Slug);
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/devmode/list");
    }

    private async Task LoadLayouts(string slug)
    {
        layouts.Clear();

        var fetched = await DevModeService.GetLayouts(slug);
        layouts.AddRange(fetched);
    }

    private void SetPreviewMap()
    {
        previewMapUrl = editModel.MapUrl ?? "";
    }

    private async Task SubmitLayout()
    {
        var response = await DevModeService.PostNewLayout(editModel, Slug);
        await ShowAlert(response);

        var isSuccess = DevModeService.GetPostStatus();
        if (isSuccess)
        {
            ClearForm();
            // refresh list of layouts
            await LoadLayouts(Slug);
        }
    }

    private async Task DeleteLayout(string? name)
    {
        var isDeleteConfirmed = await JS.InvokeAsync<bool>("showConfirmationAlert", "Do you want to delete this track layout?");
        if (isDeleteConfirmed)
        {
            var response = await DevModeService.DeleteLayout(Slug, name ?? "");
            await ShowAlert(response);

            // refresh list of layouts
            await LoadLayouts(Slug);
        }
    }

    private void ClearForm()
    {
        editModel = new();
        SetPreviewMap();
    }

    private async Task ShowAlert(string errorMessage)
    {
        await JS.InvokeVoidAsync("showAlert", errorMessage);
    }
}