@page "/devmode/layouts"
@using GTRouteApp.Data
@inject DevModeService DevModeService
@inject NavigationManager NavigationManager

<PageTitle>Dev Mode - Manage Track Layouts</PageTitle>

<div class="manage-layouts-container">
    <div class="layouts-form-nav">
        <button type="button" class="btn btn-primary" @onclick="BackToList">
            <span class="bi bi-arrow-left-square-fill"></span> Back
        </button>
    </div>

    <div class="layouts-form-content">
        <div class="form-title">
            <h5>Manage Layouts for @TrackName</h5>
        </div>

        <EditForm Model="@editModel" OnValidSubmit="SubmitLayout">
            <div class="layouts-form-group">
                <div class="form-group-1">
                    <div class="form-img">
                        <img src="" alt="Preview layout map" />
                    </div>
                </div>

                <div class="form-group-2">
                    <div class="form-block-row">
                        <form class="form-floating">
                            <InputText @bind-Value="editModel.Name" class="form-control" placeholder="Insert track layout name" />
                            <label>Layout Name</label>
                        </form>
                        <ValidationMessage For="@(() => editModel.Name)" />
                    </div>

                    <div class="form-block-row" style="margin-bottom: 2px;">
                        <form class="form-floating">
                            <InputText @bind-Value="editModel.MapUrl" 
                                @onfocusout="SetPreviewMap" 
                                class="form-control" 
                                placeholder="Insert the url to image track layout map" />
                            <label>Map Url</label>
                        </form>
                        <ValidationMessage For="@(() => editModel.MapUrl)" />
                    </div>

                    <p style="font-size: 12px; margin-bottom: 8px;">
                        *Instruction for Map Url: Insert a url image and then check if a url is 
                        valid and able to show image inside box above the form
                    </p>

                    <div class="form-row">
                        <div class="form-w50">
                            <form class="form-floating">
                                <InputNumber @bind-Value="editModel.Length" min="0" class="form-control" placeholder="Insert track layout length (km)" />
                                <label>Length &#40;km&#41;</label>
                            </form>
                            <ValidationMessage For="@(() => editModel.Length)" />
                        </div>

                        <div class="form-w50">
                            <form class="form-floating">
                                <InputNumber @bind-Value="editModel.Corners" min="0" class="form-control" placeholder="Insert number of turns" />
                                <label>Corners</label>
                            </form>
                            <ValidationMessage For="@(() => editModel.Corners)" />
                        </div>
                    </div>

                    <div class="form-block-row">
                        <button type="submit" class="btn btn-success">
                            <span class="bi bi-plus-lg"></span> Add
                        </button>
                    </div>
                </div>
            </div>

            <DataAnnotationsValidator />
        </EditForm>

        <div class="layouts-list">
            <ul>
                @foreach (var layoutItem in layouts)
                {
                    <li>@layoutItem.Name, length: @layoutItem.Length | corner: @layoutItem.Corners</li>
                }
            </ul>
        </div>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "slug")] 
    public string Slug { get; set; } = "";

    [Parameter]
    [SupplyParameterFromQuery(Name = "name")]
    public string TrackName { get; set; } = "";

    private List<TrackLayout> layouts = new();
    private LayoutEditModel editModel = new();
    private string previewMapUrl = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadLayouts(Slug);
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/devmode/list");
    }

    private async Task LoadLayouts(string slug)
    {
        var fetched = await DevModeService.GetLayouts(slug);

        layouts.AddRange(fetched);
    }

    private void SetPreviewMap()
    {
        previewMapUrl = editModel.MapUrl ?? "";
    }

    private void SubmitLayout()
    {
        Console.WriteLine($"name: {editModel.Name}, url: {editModel.MapUrl}, length: {editModel.Length}, corners: {editModel.Corners}");
    }
}