@page "/browse/detail/{slug}"

@using GTRouteApp.Data
@inject TrackDetailService TrackDetailService
@inject NavigationManager NavigationManager

<PageTitle>New Track Detail | GTRoad</PageTitle>

<div class="detail-container">
    <DetailSubheader Info="@subheaderInfoText" />

    <div class="detail-row-2">
        <DetailSidebar 
            OnSubDetailChanged="OnSubDetailChangedHandler" 
            SelectedSubDetail="@chosenSubDetail"
            CoverUrl="@detail.CoverUrl"
            LogoUrl="@detail.LogoUrl"    
        />
        @if (chosenSubDetail == SubDetail.General)
        {
            <DetailGeneral Detail="@detail" RandomImageUrl="@randomImageUrl" />
        }
        else if (chosenSubDetail == SubDetail.Layout)
        {
            <DetailLayout Layouts="@layouts" Name="@detail.Name" RandomImageUrl="@randomImageUrl" />
        }
        else
        {
            <DetailGallery Images=@images />
        }
    </div>

    <div class="back-button">
        @if (!string.IsNullOrWhiteSpace(origin))
        {
            <button type="button" class="btn btn-secondary" @onclick="() => GoBack(origin)">
                <span class="bi bi-arrow-left-square"></span> Back
            </button>
        }
        else
        {
            <button type="button" class="btn btn-secondary" @onclick="() => GoBack()">
                <span class="bi bi-arrow-left-square"></span> Browse Race Tracks
            </button>
        }
    </div>
</div>

@code {
    [Parameter]
    public string slug { get; set; } = "";

    [Parameter]
    [SupplyParameterFromQuery(Name = "origin")]
    public string origin { get; set; } = "";

    private TrackDetail detail = new();
    private List<TrackLayout> layouts = new();
    private List<TrackImage> images = new();

    private string subheaderInfoText = "View general information of --this race track--";
    private SubDetail chosenSubDetail = SubDetail.General;
    private string randomImageUrl = "";
    
    private string errorMessage = "";
    private bool showError = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDetail(slug);
        CheckError();
    }

    private async Task LoadDetail(string slug)
    {
        var data = await TrackDetailService.GetTrackDetail(slug);
        detail = data;
        layouts.AddRange(detail.Layouts);
        images.AddRange(detail.Images);

        ChangeSubheaderInfoText(detail.Name ?? "");
        GetRandomTrackImage();
    }

    private void GetRandomTrackImage()
    {
        randomImageUrl = TrackDetailService.GetRandomTrackImage(images);

        if (string.IsNullOrWhiteSpace(randomImageUrl))
        {
            randomImageUrl = detail.CoverUrl ?? "";
        }
    }

    private void OnSubDetailChangedHandler(SubDetail subDetail)
    {
        chosenSubDetail = subDetail;

        ChangeSubheaderInfoText(detail.Name ?? "");
    }

    private void ChangeSubheaderInfoText(string trackName)
    {
        switch (chosenSubDetail)
        {
            case SubDetail.General:
                subheaderInfoText = $"View general information of {trackName}";
                break;
            case SubDetail.Layout:
                subheaderInfoText = $"View available layout configurations on {trackName}";
                break;
            default:
                subheaderInfoText = $"View gallery of {trackName}";
                break;
        }
    }

    private void GoBack(string originPage = "browse")
    {
        if (originPage.Equals("home"))
        {
            NavigationManager.NavigateTo("/");
        }
        else if (originPage.Equals("browseGallery"))
        {
            NavigationManager.NavigateTo("/browse?preselect_mode=gallery");
        }
        else if (originPage.Equals("browseGrid"))
        {
            NavigationManager.NavigateTo("/browse?preselect_mode=grid");
        }
        else
        {
            NavigationManager.NavigateTo("/browse");
        }
    }

    private void CheckError()
    {
        errorMessage = TrackDetailService.GetRecentErrorMessage();
        showError = string.IsNullOrWhiteSpace(errorMessage) ? false : true;
    }
}