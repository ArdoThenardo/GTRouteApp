@page "/browse"
@using GTRouteApp.Services
@using GTRouteApp.Models
@using GTRouteApp.Helpers
@inject NavigationManager NavigationManager
@inject RaceTrackService RaceTrackService

<PageTitle>Browse | GTRoad</PageTitle>

@if (tracks == null || tracks.Count == 0)
{   
    <NoDataView Message="@errorMessage" ShowError="@showError" OnTryAgainClicked="OnTryAgainHandler" />
}
else
{
    <BrowseSubheader Info="@info" 
        OnCategoryChanged="@OnCategoryChangedHandler" 
        ChosenBrowseMode="@ChangeBrowseMode" 
        preselect_mode="@preselect_mode" 
        selectedCategory="@selectedCategory" />

    @if (_mode == BrowseMode.Gallery)
    {
        <BrowseGallery Tracks="@tracks" 
            IsMaximum="@isMaximum" 
            IsLoadMoreError="@isLoadMoreError"
            IsLoadMoreDisabled="@isLoadMoreDisabled" 
            OnLoadMoreClicked="LoadMoreTracks"
            OnViewClickHandler="AccessTrackDetail" />
    }
    else if (_mode == BrowseMode.Grid)
    {
        <BrowseGrid Tracks="@tracks" 
            IsMaximum="@isMaximum"
            FirstIndexInCurrentPage="@firstIndexInCurrentPage" 
            IsLoadMoreError="@isLoadMoreError"
            IsLoadMoreDisabled="@isLoadMoreDisabled"
            OnLoadMoreClicked="LoadMoreTracks"
            OnViewClickHandler="AccessTrackDetail" />
    }
}

@code {
    private List<RaceTrack> tracks = new();
    private int currentPage = 1;

    private const string galleryInfo = "Click or tap a track on the bottom to highlight";
    private const string gridInfo = "Click or tap a track to view";
    private const int limitPerPage = 8;

    [Parameter]
    [SupplyParameterFromQuery(Name = "category")]
    public string preselect_category { get; set; } = "";
    public string selectedCategory { get; set; } = BrowseCategory.Categories[0];

    [Parameter]
    [SupplyParameterFromQuery(Name = "mode")]
    public string preselect_mode { get; set; } = ""; // gallery or grid
    private BrowseMode _mode = BrowseMode.Gallery;
    private string info = galleryInfo;

    private bool isMaximum = false;
    private int firstIndexInCurrentPage = 0;
    private bool isLoadMoreError = false;
    private bool isLoadMoreDisabled = false;
    private string errorMessage = "";
    private bool showError = false;

    protected override async Task OnInitializedAsync()
    {
        PreselectCategory();
        
        await LoadData();
    }

    protected override void OnParametersSet()
    {
        PreselectBrowseMode();
    }

    private async Task LoadData()
    {
        await LoadTracks();
        CheckError();
    }

    private async Task LoadTracks()
    {
        var data = await RaceTrackService.GetTracks(currentPage);

        tracks.AddRange(data);
        isMaximum = RaceTrackService.IsRaceTracksReachMaximum();
    }

    private async Task LoadMoreTracks()
    {
        isLoadMoreDisabled = true;

        if (!isMaximum)
        {
            int nextPage = currentPage + 1;
            
            var data = await RaceTrackService.GetTracks(nextPage);

            if (data.Count() > 0) // fetch success, if data > 0
            {
                currentPage = nextPage;
                
                tracks.AddRange(data);
                isMaximum = RaceTrackService.IsRaceTracksReachMaximum();
                firstIndexInCurrentPage = limitPerPage * (currentPage - 1);
                isLoadMoreError = false;
            }
            else
            {
                isLoadMoreError = true;
            }

            isLoadMoreDisabled = false;
        }
    }

    private async Task OnCategoryChangedHandler(string category)
    {
        tracks.Clear();
        currentPage = 1;
        isMaximum = false;
        RaceTrackService.ResetRaceTracksList();

        selectedCategory = category;
        RaceTrackService.SetRaceTracksCategory(selectedCategory);
        NavigationManager.NavigateTo(
            NavigationManager.GetUriWithQueryParameter("category", selectedCategory)); // update url

        await LoadData();
    }

    private void PreselectCategory()
    {
        selectedCategory = string.IsNullOrWhiteSpace(preselect_category) ? 
            BrowseCategory.Categories[0] : 
            preselect_category;

        RaceTrackService.SetRaceTracksCategory(selectedCategory);
    }

    private void CheckError()
    {
        errorMessage = RaceTrackService.GetRecentErrorMessage();
        showError = string.IsNullOrWhiteSpace(errorMessage) ? false : true;
    }

    private void PreselectBrowseMode()
    {
        if (!string.IsNullOrWhiteSpace(preselect_mode))
        {
            if (preselect_mode.Equals("gallery"))
            {
                ChangeBrowseMode(BrowseMode.Gallery);
            }
            else if (preselect_mode.Equals("grid"))
            {
                ChangeBrowseMode(BrowseMode.Grid);
            }
        }
    }

    private void ChangeBrowseMode(BrowseMode mode)
    {
        this._mode = mode;
        var updatedUrl = "";

        if (this._mode == BrowseMode.Gallery)
        {
            info = galleryInfo;

            updatedUrl = NavigationManager.GetUriWithQueryParameter(
                "mode", "gallery");
            NavigationManager.NavigateTo(updatedUrl);
        }
        else if (this._mode == BrowseMode.Grid)
        {
            info = gridInfo;

            updatedUrl = NavigationManager.GetUriWithQueryParameter(
                "mode", "grid");
            NavigationManager.NavigateTo(updatedUrl);
        }
    }

    private void AccessTrackDetail(string slug)
    {
        var origin = "";
        switch (_mode)
        {
            case BrowseMode.Gallery:
                origin = "browseGallery";
                break;
            case BrowseMode.Grid:
                origin = "browseGrid";
                break;
        }

        NavigationManager.NavigateTo($"/browse/detail/{slug}?"
            +$"category={selectedCategory}&origin={origin}");
    }

    private async Task OnTryAgainHandler()
    {
        showError = false;

        await LoadData();
    }
}