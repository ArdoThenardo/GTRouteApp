@page "/"
@using GTRouteApp.Data
@inject FeaturedService FeaturedService
@inject NavigationManager NavigationManager

<PageTitle>Home</PageTitle>

<div class="home-container">
    <IndexSubheader Info="Welcome to GTRoad! Here you can look for information of race tracks that featured on Gran Turismo series." />

    @if (featured == null || featured.Count() == 0)
    {
        @if (showError)
        {
            <p>@errorMessage</p>
        }
        else
        {
            <div class="loading-traditional" style="height: 85vh;"></div>
        }
    }
    else
    {
        <div class="home-featured">
            <div class="featured-row-1">
                <div class="row-1-featured-item" 
                    style="--bg-cover: url(@featured.ElementAt(0).CoverUrl); --delay: 0s;"
                    @onclick="() => AccessTrackDetail(featured.ElementAt(0).Slug!)">
                    <div class="featured-info">
                        <img src="@featured.ElementAt(0).LogoUrl" 
                            alt="@featured.ElementAt(0).Name logo" />
                        <p class="featured-title">@featured.ElementAt(0).Name</p>
                        <p class="featured-text">@((MarkupString)(featured.ElementAt(0).Text ?? ""))</p>
                    </div>
                </div>
                <div class="row-1-featured-item" 
                    style="--bg-cover: url(@featured.ElementAt(1).CoverUrl); --delay: .15s;"
                    @onclick="() => AccessTrackDetail(featured.ElementAt(1).Slug!)">
                    <div class="featured-info">
                        <img src="@featured.ElementAt(1).LogoUrl" 
                            alt="@featured.ElementAt(1).Name logo" />
                        <p class="featured-title">@featured.ElementAt(1).Name</p>
                        <p class="featured-text">@((MarkupString)(featured.ElementAt(1).Text ?? ""))</p>
                    </div>
                </div>
            </div>
            <div class="featured-row-2">
                <div class="row-2-featured-item" 
                    style="--bg-cover: url(@featured.ElementAt(2).CoverUrl); --delay: .2s;"
                    @onclick="() => AccessTrackDetail(featured.ElementAt(2).Slug!)">
                    <div class="featured-info">
                        <img src="@featured.ElementAt(2).LogoUrl" 
                            alt="@featured.ElementAt(2).Name logo" />
                        <p class="featured-title">@featured.ElementAt(2).Name</p>
                        <p class="featured-text">@((MarkupString)(featured.ElementAt(2).Text ?? ""))</p>
                    </div>
                </div>
                <div class="row-2-featured-item" 
                    style="--bg-cover: url(@featured.ElementAt(3).CoverUrl); --delay: .25s;"
                    @onclick="() => AccessTrackDetail(featured.ElementAt(3).Slug!)">
                    <div class="featured-info">
                        <img src="@featured.ElementAt(3).LogoUrl" 
                            alt="@featured.ElementAt(3).Name logo" />
                        <p class="featured-title">@featured.ElementAt(3).Name</p>
                        <p class="featured-text">@((MarkupString)(featured.ElementAt(3).Text ?? ""))</p>
                    </div>
                </div>
                <div class="row-2-featured-item" 
                    style="--bg-cover: url(@featured.ElementAt(4).CoverUrl); --delay: .3s"
                    @onclick="() => AccessTrackDetail(featured.ElementAt(4).Slug!)">
                    <div class="featured-info">
                        <img src="@featured.ElementAt(4).LogoUrl" 
                            alt="@featured.ElementAt(4).Name logo" />
                        <p class="featured-title">@featured.ElementAt(4).Name</p>
                        <p class="featured-text">@((MarkupString)(featured.ElementAt(4).Text ?? ""))</p>
                    </div>
                </div>
            </div>
        </div>
    }
    <div class="in-progress-notice">
        <h4>
            <span class="bi bi-cone-striped" style="margin-right: 8px;"></span>
            More Race Track entries will be added in the future
            <span class="bi bi-cone-striped" style="margin-left: 8px;"></span>
        </h4>
        <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer at sem et justo lobortis venenatis. 
            Sed luctus, massa quis dapibus sollicitudin, dui arcu posuere tellus, in dignissim felis sem et nisi. 
            Vivamus feugiat nunc vitae magna facilisis eleifend. Nulla condimentum nisi dui, vitae ullamcorper massa pellentesque id.
        </p>
    </div>
</div>

@code {
    private List<FeaturedTrack> featured = new();

    private string errorMessage = "";
    private bool showError = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadFeatured();
        CheckError();
    }

    private async Task LoadFeatured()
    {
        var fetched = await FeaturedService.GetFeatured();
        featured.AddRange(fetched);
    }

    private void AccessTrackDetail(string slug)
    {
        NavigationManager.NavigateTo($"/detail/{slug}?origin=home");
    }

    private void CheckError()
    {
        errorMessage = FeaturedService.GetRecentErrorMessage();
        showError = string.IsNullOrWhiteSpace(errorMessage) ? false : true;
    }
}