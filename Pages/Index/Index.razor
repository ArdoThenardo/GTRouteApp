@page "/"
@using GTRouteApp.Services
@using GTRouteApp.Models
@inject FeaturedService FeaturedService
@inject NavigationManager NavigationManager

<PageTitle>Home | GTRoad</PageTitle>

<div class="home-container">
    @if (featured == null || featured.Count() == 0)
    {
        <NoDataView Message="@errorMessage" ShowError="@showError" OnTryAgainClicked="OnTryAgainHandler" />
    }
    else
    {
        <IndexSubheader Info="Welcome to GTRoad! Here you can look for information of race tracks that featured on Gran Turismo series." />

        <IndexFeaturedTrack Featured="@featured" />

        <IndexFeaturedMedia />

        <IndexNotice />
    }
</div>

@code {
    private List<FeaturedTrack> featured = new();

    private string errorMessage = "";
    private bool showError = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        await LoadFeatured();
        CheckError();
    }

    private async Task LoadFeatured()
    {
        var fetched = await FeaturedService.GetFeatured();
        featured.AddRange(fetched);
    }

    private void AccessTrackDetail(string slug)
    {
        NavigationManager.NavigateTo($"/browse/detail/{slug}?origin=home");
    }

    private void CheckError()
    {
        errorMessage = FeaturedService.GetRecentErrorMessage();
        showError = string.IsNullOrWhiteSpace(errorMessage) ? false : true;
    }

    private async Task OnTryAgainHandler()
    {
        showError = false;

        await LoadData();
    }
}